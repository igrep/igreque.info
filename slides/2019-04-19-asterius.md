---
title: Asteriusã§Haskellã®é–¢æ•°ã‚’JSã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸï¼ˆã‘ã©å¤±æ•—ï¼‰
author: Yuji Yamamoto (å±±æœ¬æ‚ æ»‹)
date: 2019-04-19 Emscripten & WebAssembly night !! #7

---

# ã¯ã˜ã‚ã¾ã—ã¦ï¼ (\^-\^)

- [å±±æœ¬æ‚ æ»‹](https://twitter.com/igrep) ([\@igrep](https://twitter.com/igrep))
- Haskellæ­´ â‰’ ãƒ—ãƒªã‚­ãƒ¥ã‚¢ãŠã˜ã•ã‚“æ­´ â‰’ ç´„7å¹´ã€‚
- è¶£å‘³Haskellerå…¼ä»•äº‹Haskeller @ [IIJ-II](https://www.iij-ii.co.jp/) ðŸ˜„
- igrep.elã¨ã„ã†Emacsãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚Šã¾ã™ãŒç„¡é–¢ä¿‚ã§ã™ï¼

# å®£ä¼ hask(\_ \_)eller

- 2017å¹´ã‹ã‚‰[æ—¥æœ¬Haskellãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—](https://haskell.jp/)ã¨ã„ã†ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç«‹ã¡ä¸Šã’ã€ãã®ç™ºèµ·äººã®ä¸€äººã¨ã—ã¦æ´»å‹•ã—ã¦ãŠã‚Šã¾ã™ã€‚
    - æ„›ç§°: Haskell-jp
- [Slackã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹](https://haskell.jp/signin-slack.html)ã‚„[Subreddit](https://www.reddit.com/r/haskell_jp/)ã€[ãƒ–ãƒ­ã‚°](https://haskell.jp/)ã€[Wiki](http://wiki.haskell.jp/)ãªã©ã€ã„ã‚ã„ã‚é‹å–¶ã—ã¦ãŠã‚Šã¾ã™ã€‚

# Topics and Summary

â€»From this slide, written in English to show the developer of Asterius.

- ðŸ”What Asterius is.
- âš™ï¸How Asterius works.
- ðŸ’ªI tried to run a function I wrote in Haskell before on a browser.
    - ðŸ˜¥But in vail due to a bug of Asterius's FFI.

# ðŸ”What Asterius is:

- [A Haskell to WebAssembly compiler](https://github.com/tweag/asterius).
- Still in heavy development.
- All GHC features except Template Haskell and most standard IO functions should work.
- Provides FFI to call JavaScript from Haskell, and Haskell from JavaScript, vice versa.
    - Call JavaScript functions to perform some IOs.
- Now provides `ahc-cabal` command to build a module dependent on external packages.

# ðŸ‘Asterius's Pros

- Output wasm is relatively small (considering it contains a runtime of Haskell).
    - Empty project:
        - 36KB (only `.wasm` file).
        - 168KB (including uncompressed `.mjs` files).
    - ðŸ˜•My app:
        - 1.9MB (only `.wasm` file).
        - 2.1MB (including uncompressed `.mjs` files).

# ðŸ‘Asterius's Pros (cont)

- Available with HEAD of GHC!
    - Forked from GHC. But the diff from original GHC is so small that the developer can rebase regularly.

# ðŸ‘ŽAsterius's Cons

- Still very unstable and buggy.
- Most standard IO functions and Template Haskell aren't available.
    - Call JavaScript functions to perform some IOs.
    - Currently few wrappers around JavaScript functions are provided unless declaring `foreign import javascript` explicitly...

# ðŸ‘ŽAsterius's Cons (cont)

- Only works on V8 and SpiderMonkey
    - The runtime JavaScript modules depend on `BigInt`.
    - Use Firefox Nightly or Chrome!

# âš™ï¸How Asterius works

Ref: [IR types and transformation passes](https://tweag.github.io/asterius/ir/)

1. Wrap the fork of GHC with a frontend plugin:
    - Convert `.cmm` files to `AsteriusModule` (custom object format for Asterius).
1. `ahc-ld` (dedicated linker) links for WASM.

# âš™ï¸How Asterius works (cont)

3. `ahc-dist` makes it executable.
    - With [binaryen](https://github.com/WebAssembly/binaryen) or [wasm-toolkit](https://github.com/tweag/asterius/tree/master/wasm-toolkit), validate and convert the modules to WASM module.
    - Copy JavaScript modules required at runtime.
    - Emit the entry JavaScript module to run the `main` function of the source Haskell file.

# How I tried to run my function with Asterius

[The target app](https://github.com/igrep/igrep-cashbook/tree/master/hs2):

- Parse a simple line-separated file to sum up my expenditure.
- Tried to export the core function typed as  
  `FilePath -> Text -> Text` using FFI.

# How I tried to run my function with Asterius (cont)

ðŸ”¥I had to drop some dependent packages to compile my code...

- To avoid to depend on Template Haskell and IO.
- ðŸ˜¨If any of the dependency depends on them, fails to build.

# How I tried to run my function with Asterius (cont)

- But avoiding IO is actually easy by believing in types!
- Haskell is *very* good at writing pure functions!
- In Haskell, IO is always explicitly typed as `IO`:
    - Easily detect which functions do IO, then split them out!
    - âœ¨Impure functions don't spark joy!

# Result

- Successfully built a module exporting the core function.
- But finally got stuck by [a bug of FFI](https://github.com/tweag/asterius/issues/105).
    - The `foreign export javascript`ed function doesn't return the expected result!
- Perhaps I can avoid by not using `foreign export javascript`, but left so far.

# âœ…Summary

- Asterius is a Haskell to WebAssembly compiler.
- Now we can run various Haskell code on a browser!
    - But currently we have to drop much code to compile...
