---
title: GHC 8.xå‹‰å¼·ä¼š QuantifiedConstraintsç·¨
author: Yuji Yamamoto (å±±æœ¬æ‚ æ»‹)
date: 2018-12-07

---

# GHC 8.6.1ã‹ã‚‰å…¥ã£ãŸ`QuantifiedConstraints`

- [GHC Users Guide](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#extension-QuantifiedConstraints)
    - å¤§åŠã®ä¾‹ã¯ã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒšãƒ»å¾®ä¿®æ­£ã—ã¦ã„ã¾ã™
- è«–æ–‡ [Quantified Class Constraints](https://i.cs.hku.hk/~bruno//papers/hs2017.pdf)
- HIW 2018ã®[Generalized Abstract GHC.Generics](https://icfp18.sigplan.org/event/hiw-2018-papers-generalized-abstract-ghc-generics)ã§ã‚‚è¨€åŠãŒã‚ã£ãŸ

# ä½•ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹

- contextã«åˆ—æŒ™ã™ã‚‹constraintã®ä¸­ã§ã•ã‚‰ã«ä¸€æ®µå…¥ã‚Œå­ã®contextãŒæ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸï¼

# ã©ã‚†ã“ã¨ï¼Ÿ

```haskell
data Rose f x = Branch x (f (Rose f x))

instance (Eq a, forall b. Eq b => Eq (f b)) => Eq (Rose f a) where
  (Branch x1 rs1) == (Branch x2 rs2) = x1 == x2 && rs1 == rs2
```

# ã©ã‚†ã“ã¨ï¼Ÿ

```haskell
instance (Eq a, forall b. Eq b => Eq (f b)) => ...
```

ã®ã€`forall b. Eq b => Eq (f b)`ã®ç®‡æ‰€ï¼

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

ã“ã‚“ãªæ„Ÿã˜ã®å‹ãŒã‚ã£ã¦ã€`Eq`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®šç¾©ã—ãŸã„

```haskell
data Rose f x = Branch x (f (Rose f x))
```

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

ã“ã‚Œã¯ã‚ˆããªã„ï¼

```haskell
instance (Eq a, Eq (f (Rose f a))) => Eq (Rose f a)
  where
    (Branch x1 c1) == (Branch x2 c2)
       = x1==x1 && c1==c2
```

- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è§£æ±ºãŒåœæ­¢ã—ãªã„æã‚ŒãŒã‚ã‚‹ï¼  
  ï¼ˆUndecidableInstancesã‚’æœ‰åŠ¹ã«ã™ã‚Œã°ã§ãã¡ã‚ƒã†å ´åˆã‚‚ã‚ã‚‹ï¼‰

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

`QuantifiedConstraints`ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ï¼

<!--
:set -XQuantifiedConstraints
-->

```haskell
instance (Eq a, forall b. Eq b => Eq (f b)) => Eq (Rose f a)
  where
    (Branch x1 c1) == (Branch x2 c2)
       = x1 == x1 && c1 == c2
```

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

`QuantifiedConstraints`ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ï¼

- contextã«åˆ—æŒ™ã™ã‚‹constraintã®ä¸­ã§constraintãŒæ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹
- ä¾‹ãˆã°ğŸ‘‡ã‚‚OKã€‚  
  ```haskell
  f :: (Eq a, forall b. Eq b => Eq (f b)) => Rose f a -> Rose f a -> Bool
  f t1 t2 = not (t1 == t2)
  ```

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

ã‚‚ã£ã¨ã†ã‚Œã—ãã†ãªä¾‹:  

- å¾“æ¥ã®[`MonadTrans`](http://hackage.haskell.org/package/transformers-0.5.5.0/docs/Control-Monad-Trans-Class.html#t:MonadTrans)å‹ã‚¯ãƒ©ã‚¹  
  ```haskell
  class MonadTrans t where
    lift :: Monad m => m a -> t m a
  ```

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

```haskell
class MonadTrans t where
  lift :: Monad m => m a -> t m a
```

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

å¾“æ¥ã®`MonadTrans`ã ã¨ã€ğŸ‘‡ã®`MonadTrans`ãŒå®šç¾©ã§ããªã„ï¼

<!--
:set -XKindSignatures
:set -XPolyKinds
:m + Control.Monad.Trans.Class Data.Kind

:{
newtype Comp
    (t1 :: ((* -> *) -> * -> *))
    (t2 :: ((* -> *) -> * -> *))
    (m :: Type -> Type) a =
    Comp { runComp :: t1 (t2 m) a }
:}
-->

```haskell
newtype Comp t1 t2 m a = Comp { runComp :: t1 (t2 m) a }

instance (MonadTrans t1, MonadTrans t2) => MonadTrans (Comp t1 t2) where
  lift = Comp . lift . lift
```

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

`lift`ã®ç¬¬1å¼•æ•°ãŒå®ˆã‚‹ã¹ã`Monad m`ã‚’æº€ãŸã›ãªã„ï¼

```
â€¢ Could not deduce (Monad (t2 m)) arising from a use of â€˜liftâ€™
  from the context: (MonadTrans t1, MonadTrans t2)
    bound by the instance declaration at <interactive>:53:10-66
  or from: Monad m
    bound by the type signature for:
      lift :: forall (m :: * -> *) a. Monad m => m a -> Comp t1 t2 m a
```

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

ã“ã‚Œãªã‚‰ã§ãã‚‹ï¼ğŸ‘

```haskell
instance
  (MonadTrans t1, MonadTrans t2, forall m. Monad m => Monad (t2 m))
  -- (MonadTrans t1, MonadTrans t2, forall m. Monad m)
  => MonadTrans (Comp t1 t2)
 where
  lift = Comp . lift . lift
```

<!--
:m +Control.Monad.Trans.Reader Control.Monad.Trans.Writer Control.Monad.Trans.State Control.Monad.IO.Class
type RS a = Comp (ReaderT Char) (StateT Int) (WriterT String IO) a
:{
act :: RS ()
act = lift . liftIO $ putStrLn "hello"
:}
-->

# ä½•ãŒã†ã‚Œã—ã„ï¼Ÿ

ãã‚‚ãã‚‚ã€ğŸ‘‡ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã‚‚ã§ãã‚‹ï¼

```
class (forall m. Monad m => Monad (t m)) => MonadTrans' t where
  lift :: Monad m => m a -> (t m) a
```

# ã¡ã‚‡ã£ã¨ä¸æ€è­°ãªç‚¹

```haskell
forall m. Monad m  
```

ã¿ãŸã„ã«æ›¸ãã¨ã€å‹å¤‰æ•°`m`ã¯  

```haskell
lift = Comp . lift . lift  
```

ã®ä¸­ã§ã¯æœ‰åŠ¹ã§ãªã„ã‚ˆã†ã«èª­ã‚ã‚‹ã‘ã©ã€å®Ÿéš›ã«ã¯æœ‰åŠ¹ã‚‰ã—ã„ã€‚

- `forall m.`ã‚’æ¶ˆã™ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†
- äº‹æƒ…ãŒã‚ã£ã¦ãã†ã„ã†ä»•æ§˜ã«ã—ãŸæ¨¡æ§˜

# [Generalized Abstract GHC.Generics](https://icfp18.sigplan.org/event/hiw-2018-papers-generalized-abstract-ghc-generics)ã§ã®å¿œç”¨

åŠ›å°½ããŸã®ã§ã‚³ãƒ”ãƒšã¯çœç•¥ã€‚æ™‚é–“ãŒä½™ã£ãŸã‚‰PDFã‚’é–‹ããªãŒã‚‰ç´¹ä»‹ã—ã‚ˆã†ï¼
