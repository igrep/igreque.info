---
title: æœ€è¿‘ã®stackã¨cabalã«ã¤ã„ã¦ç°¡å˜ã«
author: YAMAMOTO Yuji (å±±æœ¬æ‚ æ»‹)
date:  2019-11-29 Gotanda.hs #1 @HERP

---

# ã¯ã˜ã‚ã¾ã—ã¦ï¼ ğŸ‘‹ğŸ˜„

- [å±±æœ¬æ‚ æ»‹](https://twitter.com/igrep) ([\@igrep](https://twitter.com/igrep))
- Haskellæ­´ â‰’ ãƒ—ãƒªã‚­ãƒ¥ã‚¢ãŠã˜ã•ã‚“æ­´ â‰’ ç´„7å¹´ã€‚
- è¶£å‘³Haskellerå…¼ä»•äº‹Haskeller @ [IIJ-II](https://www.iij-ii.co.jp/) ğŸ˜
- igrep.elã¨ã„ã†Emacsãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚Šã¾ã™ãŒç„¡é–¢ä¿‚ã§ã™ï¼

# å®£ä¼ hask(\_ \_)eller

- 2017å¹´ã‹ã‚‰[æ—¥æœ¬Haskellãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—](https://haskell.jp/)ã¨ã„ã†ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç«‹ã¡ä¸Šã’ã€ãã®ç™ºèµ·äººã®ä¸€äººã¨ã—ã¦æ´»å‹•ã—ã¦ãŠã‚Šã¾ã™ã€‚
    - æ„›ç§°: Haskell-jp
- [Slackã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹](https://haskell.jp/signin-slack.html)ã‚„[Subreddit](https://www.reddit.com/r/haskell_jp/)ã€[ãƒ–ãƒ­ã‚°](https://haskell.jp/)ã€[Wiki](http://wiki.haskell.jp/)ãªã©ã€ã„ã‚ã„ã‚é‹å–¶ã—ã¦ãŠã‚Šã¾ã™ã€‚

# å®£ä¼ hask(\_ \_)eller

- ã€Œhaskell.jpã€ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ´»ç”¨ã—ã€ã€Œå…¬å¼é¢ã—ã¦ã€ç™ºä¿¡ã™ã‚‹äººã‚’å‹Ÿé›†ã—ã¦ã¾ã™ã€‚
    - ãƒ–ãƒ­ã‚°ã‚’æ›¸ã„ãŸã‚Šã€ŒHaskell-jpã€ã¨ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œã£ãŸã‚Šã€ãªã©ãªã©ã€‚
- ğŸ‘‡ã®å¤§ããªã‚´ãƒ¼ãƒ«ã«å…±æ„Ÿã—ã€ç¯€åº¦ã‚’å®ˆã£ã¦æ´»å‹•ã—ã¦ã„ãŸã ã‘ã‚‹æ–¹ãªã‚‰èª°ã§ã‚‚ğŸ†—
    - æ—¥æœ¬ã«Haskellã‚’æ™®åŠã•ã›ã‚‹
    - æ—¥æœ¬ã‚’ä»£è¡¨ã™ã‚‹Haskellã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãªã‚‹

# ğŸ“ä»Šæ—¥è©±ã™ã“ã¨

- ğŸ‘ğŸ‘ä»Šã¯cabalã§ã‚‚stackã§ã‚‚ã©ã£ã¡ã§ã‚‚ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªï¼
- cabalã«å¯¾ã™ã‚‹stackã®ã„ã„ã¨ã“ã‚
- stackã«å¯¾ã™ã‚‹cabalã®ã„ã„ã¨ã“ã‚
- æ•¢ãˆã¦ä¸¡æ–¹ä½¿ãˆã°ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªï¼
- ãŠã¾ã‘: ã‹ã¤ã¦ã®cabalã®ã„ã‘ã¦ãªã‹ã£ãŸã¨ã“ã‚

# âš ï¸ãŠã“ã¨ã‚ã‚Š

- ğŸ™‡ã“ã“ã§ã„ã†ã€Œcabalã€ã¯ã€Œ[cabal-install](http://hackage.haskell.org/package/cabal-install)ã€ã®ã“ã¨ã§ã™
    - ã„ã‚ã‚†ã‚‹ã€Œcabalã‚³ãƒãƒ³ãƒ‰ã€
    - [Cabal](hackage.haskell.org/package/Cabal)ã¨ã„ã†cabal-installãŒä½¿ã£ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚‚åŒã˜åå‰ãªã®ã§æ³¨æ„
- ğŸ™‡åŸºæœ¬çš„ã«cabal-install 3.0ã‚’å‰æã¨ã—ã¦ã„ã¾ã™

# ğŸ‘ğŸ‘ä»Šã¯cabalã§ã‚‚stackã§ã‚‚ã©ã£ã¡ã§ã‚‚ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªï¼

- ğŸ’ªcabalã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ç”Ÿã¾ã‚ŒãŸã‘ã©ã€ä»Šã¯cabalã‚‚é€²åŒ–ã—ãŸï¼
- ä»Šæ—¥ã¯ãã‚“ãªä»Šã®cabalã¨stackã‚’æ¯”è¼ƒã—ã¾ã™
- âš ï¸ç¶²ç¾…çš„ãªæ¯”è¼ƒã§ã¯ãªã„ã—ã€ã€Œâ€»å€‹äººã®æ„Ÿæƒ³ã§ã™ã€ã‚‚å¤šã„ã®ã§ã”æ³¨æ„ã‚’ï¼

# cabalã«å¯¾ã™ã‚‹stackã®ã„ã„ã¨ã“ã‚

- ğŸ¤—ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå„ªã—ã„
- ğŸ“¦hpackã®çµ„ã¿è¾¼ã¿ã‚µãƒãƒ¼ãƒˆ
- ğŸ˜æ°—ã®åˆ©ã„ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹
- â¬GHCã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæ¥½ã¡ã‚“

# cabalã«å¯¾ã™ã‚‹stackã®ã„ã„ã¨ã“ã‚

ğŸ¤—ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå„ªã—ã„

- cabalã¯ç‰¹ã«cabalãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‹ã‚Šã¥ã‚‰ã„
    - stackå´ã«ã´ã£ãŸã‚Šç›¸å½“ã™ã‚‹ã‚‚ã®ãŒãªã„ã®ã§å˜ç´”æ¯”è¼ƒã¯ã§ããªã„
    - hpackã‚’ä½¿ãˆã°ãã®ã‚ã‹ã‚Šã¥ã‚‰ã•ã«é­ã†ãƒªã‚¹ã‚¯ã‚‚æ¸›ã‚‹
- stackã¯ã€Œã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ä»Šã®resolverã«ãªã„ã‹ã‚‰ã“ã®è¡Œã‚’stack.yamlã«æ›¸ã„ã¦ã­ï¼ã€ã¨æ•™ãˆã¦ãã‚Œã‚‹ã€ãªã©ãªã©

# cabalã«å¯¾ã™ã‚‹stackã®ã„ã„ã¨ã“ã‚

ğŸ“¦hpackã®çµ„ã¿è¾¼ã¿ã‚µãƒãƒ¼ãƒˆ

- å‰è¿°ã®cabalãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ã‹ã‚Šã¥ã‚‰ã•ã«ä»˜ãåˆã†å¿…è¦ãŒãªããªã‚‹
- hpackã¯cabalã‚ˆã‚Šã‚‚DRYã«æ›¸ãã‚„ã™ã„
    - ã§ã‚‚ã€cabalã‚‚ã€Œcommon stanzaã€æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã®ã§ãã®å·®ã¯ç¸®ã¾ã£ãŸ
    - [cabal-fmt](http://hackage.haskell.org/package/cabal-fmt)ãŒã§ããŸã“ã¨ã§moduleã®åˆ—æŒ™ã‚‚åŠè‡ªå‹•åŒ–ã§ãã‚‹
- ğŸ™å€‹äººçš„ã«ã¯cabalã«æ…£ã‚Œã¦æ¬²ã—ã„æ°—æŒã¡

# cabalã«å¯¾ã™ã‚‹stackã®ã„ã„ã¨ã“ã‚

ğŸ˜æ°—ã®åˆ©ã„ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹

- `--file-watch`
    - ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›£è¦–ã—ã¦è‡ªå‹•ã§ãƒªãƒ“ãƒ«ãƒ‰ï¼
- `--pedantic`
    - `--ghc-options=-Wall -Werror`ã¨ç­‰ä¾¡
- `--fast`
    - `--ghc-options=-O0`ã¨ç­‰ä¾¡

# cabalã«å¯¾ã™ã‚‹stackã®ã„ã„ã¨ã“ã‚

â¬GHCã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæ¥½ã¡ã‚“

- ã”å­˜çŸ¥ã®ã¨ãŠã‚Šã€`stack build`ã™ã‚‹ã ã‘ã§ã€å¿…è¦ãªGHCãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãªã‘ã‚Œã°è‡ªå‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- GHCã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ã ã‘ã®æ™‚ã¯`stack setup`

# stackã«å¯¾ã™ã‚‹cabalã®ã„ã„ã¨ã“ã‚

- â„ï¸enable executable static
- ğŸš§é–‹ç™ºç‰ˆã®GHCã§ã‚‚ï¼
- â—€ï¸Backpackä½¿ã†ãªã‚‰å¿…é ˆ
- ğŸ“šä¸€ã¤ã®cabalãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ãŒï¼
- â­ï¸å®Ÿã¯Stackageã®æ©æµã‚’å—ã‘ã‚‹ã®ã‚‚ç°¡å˜

# â„ï¸enable executable static

- `cabal build --enable-executable-static`
- æ˜¨ä»Šã®ã¯ã‚„ã‚Šã€ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªãƒ¼ãŒç°¡å˜ã«ä½œã‚Œã‚‹ï¼
- âš ï¸ãŸã ã—ã€ä¸»ã«glibcã®éƒ½åˆã§çµå±€å®Ÿè¡Œæ™‚ã«glibcãŒå¿…è¦ã«ãªã£ã¦ã—ã¾ã†ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã®ã§æ³¨æ„
    - [GNU ldã§ä¸€éƒ¨ã‚’ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒªãƒ³ã‚¯ã«ã™ã‚‹](https://fukasawah.github.io/posts/2019/01/07/a-part-static-link-in-gnu-ld/)

# ğŸš§é–‹ç™ºç‰ˆã®GHCã§ã‚‚ï¼

- `-w`ï¼ˆã¾ãŸã¯`--with-compiler`ï¼‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ä½¿ã„ãŸã„GHCã¸ã®ãƒ‘ã‚¹ã‚’æ˜ç¤ºã™ã‚Œã°ã€ã„ã¤ã§ã‚‚å¥½ããªGHCã‚’ä½¿ãˆã‚‹ï¼
- cabal 2.xã ã¨`--with-ghc`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚ˆã†ã§ã™

# â—€ï¸Backpackä½¿ã†ãªã‚‰å¿…é ˆ

Backpack: GHC 8.2ã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸæ©Ÿèƒ½

- ã€Œmoduleã®interfaceã€çš„ãªã‚‚ã®ãŒã§ãã‚‹
- è©³ã—ãã¯[Haskell Backpack è¦šãˆæ›¸ã](https://matsubara0507.github.io/posts/2017-12-12-backpack-memo.html)ã‚’
- å€‹äººçš„ã«ã¯ã€Œã‚„ã£ã±ã‚Šã ã„ãŸã„å‹ã‚¯ãƒ©ã‚¹ã§ã©ã†ã«ã‹ãªã‚‹ã˜ã‚ƒã­ãƒ¼ã‹ã€ã¨ã„ã†å°è±¡
    - å‹ã‚¯ãƒ©ã‚¹ã ã¨ã‚ˆã‚Šç­‹åŠ›ğŸ’ªãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã‚’ã™ã£ãã‚Šã§ãã‚‹ã¿ãŸã„ã ã‘ã©...
- [stackã¯å½“åˆ†ã‚µãƒãƒ¼ãƒˆã—ãã†ã«ãªã„](https://github.com/commercialhaskell/stack/issues/2540)

# ğŸ“šä¸€ã¤ã®cabalãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ãŒï¼

- [Multiple public libraries in a package Â· Issue #4206 Â· haskell/cabal](https://github.com/haskell/cabal/issues/4206)
- cabal 3.0ã‹ã‚‰ã‚µãƒãƒ¼ãƒˆ
- æã‚‰ãå‰è¿°ã®Backpackã®ãŸã‚ã«ã‚‚ã‚ã£ã¦ã—ã‹ã‚‹ã¹ãæ©Ÿèƒ½

# ğŸ“šä¸€ã¤ã®cabalãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ãŒï¼

ä¾‹ãˆã°`aeson`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã£ãŸã¨ã:

- pretty printerã¨ã—ã¦`aeson-pretty`ã‚’ä½œã£ãŸã‚Š
- `Value`å‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã£ãŸã‚Š
- ãªã©ãªã©ã€ä»Šã¾ã§åˆ†ã‹ã‚Œã¦ã„ãŸé–¢é€£ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã€ä¸€ã¤ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã¨ã—ã¦é…å¸ƒã§ãã‚‹

# â­ï¸å®Ÿã¯Stackageã®æ©æµã‚’å—ã‘ã‚‹ã®ã‚‚ç°¡å˜

ä¾‹ãˆã°LTS 14.16ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã„ãŸã„ã¨ã:

```
curl https://www.stackage.org/lts-14.16/cabal.config > cabal.project.freeze
```

- ãŸã£ãŸã“ã‚Œã ã‘ï¼

# â­ï¸å®Ÿã¯Stackageã®æ©æµã‚’å—ã‘ã‚‹ã®ã‚‚ç°¡å˜

ã‚³ãƒ„:

- `cabal v2-build`ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«`cabal v2-update`ã—ã¦ãŠãã¨ã€[Hackage Metadata Revision](https://github.com/haskell-infra/hackage-trustees/blob/master/revisions-information.md)ã®å•é¡Œã‚’å›é¿ã§ãã¾ã™
- stackã¯ã“ã®è¾ºã®å•é¡ŒãŒãã‚‚ãã‚‚èµ·ã“ã‚‰ãªã„ã‚ˆã†ã«ã†ã¾ã„ã“ã¨ç®¡ç†ã—ã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ã‚„ã£ã±ã‚Šstackã®æ–¹ãŒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼
    - å…·ä½“çš„ã«ã¯ã€Stackageã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…¥ã£ãŸtarballã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãªã©ã€ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’æ›¸ãã“ã¨ã§è§£æ±ºã—ã¦ã„ã‚‹

# æ•¢ãˆã¦ä¸¡æ–¹ä½¿ãˆã°ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªï¼

- ä¾‹: stackã‚’GHCã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ä½¿ã£ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ãã¯cabal:
    - `cabal v2-build -w "$(stack path --compiler-exe)"`
    - ç¾çŠ¶ç§ã¯æƒ°æ€§ã§stackã‚’ä½¿ã£ã¦cabalã®æ©Ÿèƒ½ãŒæ¬²ã—ã„ã¨ãã¯ã“ã†ã™ã‚‹
    - stackãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸGHCã‚’å†åˆ©ç”¨ã§ãã‚‹ã®ãŒãƒŸã‚½

# ãŠã¾ã‘: ã‹ã¤ã¦ã®cabalã®ã„ã‘ã¦ãªã‹ã£ãŸã¨ã“ã‚

- ã€ŒåŒã˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯<small>ï¼ˆä¸€ã¤ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸DBã«ã¤ãï¼‰</small>ä¸€ã¤ã¾ã§ï¼ã€ã¨ã„ã†åˆ¶ç´„ãŒ
- ğŸ¤”ãªãœãã‚Œã§ã¯ãƒ€ãƒ¡ï¼Ÿ
    - ã€ŒåŒã˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‹ã¤ã€ã€Œã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ãƒ“ãƒ«ãƒ‰ã—ãŸã‹ã€ã®**çµ„ã¿åˆã‚ã›ã‚‚ä¸€é€šã‚Šã ã‘**ã€ã¨ã„ã†åˆ¶ç´„ã‚‚ã‚ã‚‹ã‹ã‚‰

# ãŠã¾ã‘: ã‹ã¤ã¦ã®cabalã®ã„ã‘ã¦ãªã‹ã£ãŸã¨ã“ã‚

- å›³è§£ã™ã‚‹ã®ã¯é¢å€’ãªã®ã§[How we might abolish Cabal Hell, part 2](http://www.well-typed.com/blog/2015/01/how-we-might-abolish-cabal-hell-part-2/)ã‚’è¦‹ã‚ˆã†ï¼

# å‚è€ƒãƒ»ä½µã›ã¦èª­ã¿ãŸã„

- [Backpack for Stack Â· Issue #2540 Â· commercialhaskell/stack](https://github.com/commercialhaskell/stack/issues/2540)
- [GNU ldã§ä¸€éƒ¨ã‚’ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒªãƒ³ã‚¯ã«ã™ã‚‹](https://fukasawah.github.io/posts/2019/01/07/a-part-static-link-in-gnu-ld/)
- [Haskell Backpack è¦šãˆæ›¸ã](https://matsubara0507.github.io/posts/2017-12-12-backpack-memo.html)
- [Well-Typed - The Haskell Consultants: How we might abolish Cabal Hell, part 2](http://www.well-typed.com/blog/2015/01/how-we-might-abolish-cabal-hell-part-2/)
- [Why Not Both? - fommil - Medium](https://medium.com/@fommil/why-not-both-8adadb71a5ed)
- [Multiple public libraries in a package Â· Issue #4206 Â· haskell/cabal](https://github.com/haskell/cabal/issues/4206)
- [cabal ã‚³ãƒãƒ³ãƒ‰ã¨ã®å¯¾å¿œè¡¨](https://haskell.e-bigmoon.com/stack/tips/cabal.html)
- [cabal-fmt ã®ç´¹ä»‹](https://haskell.e-bigmoon.com/posts/2019/10-07-cabal-fmt.html)
